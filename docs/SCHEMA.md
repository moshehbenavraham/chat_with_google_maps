# Database Schema Conventions

This document outlines the schema conventions and patterns used in the Chat with Google Maps application database.

## Overview

The application uses PostgreSQL as the database with Drizzle ORM for schema definition and migrations. Tables are designed to be compatible with Better Auth for future authentication integration.

## Table Naming Conventions

| Convention   | Pattern               | Example                               |
| ------------ | --------------------- | ------------------------------------- |
| Table names  | Plural, snake_case    | `users`, `sessions`                   |
| Column names | snake_case in DB      | `user_id`, `created_at`               |
| Primary keys | `id` (text type)      | UUID strings generated by application |
| Foreign keys | `{singular_table}_id` | `user_id` references `users.id`       |

## Data Types

| Use Case        | PostgreSQL Type | Drizzle Type  |
| --------------- | --------------- | ------------- |
| Primary keys    | `TEXT`          | `text()`      |
| Email addresses | `TEXT`          | `text()`      |
| User names      | `TEXT`          | `text()`      |
| URLs            | `TEXT`          | `text()`      |
| Booleans        | `BOOLEAN`       | `boolean()`   |
| Timestamps      | `TIMESTAMP`     | `timestamp()` |

### Why TEXT for IDs?

The application uses `TEXT` type for primary keys rather than `UUID` to:

1. Match Better Auth expected format
2. Allow flexibility in ID generation strategies
3. Support external ID formats if needed

IDs are UUID strings generated by the application layer (e.g., using `crypto.randomUUID()`).

## Timestamp Handling

All tables include standard timestamp columns:

```typescript
createdAt: timestamp('created_at').defaultNow().notNull(),
updatedAt: timestamp('updated_at').defaultNow().notNull(),
```

- `created_at`: Set automatically on insert via `defaultNow()`
- `updated_at`: Set on insert, must be updated manually on modifications

**Note**: PostgreSQL does not automatically update `updated_at`. Applications should set this field explicitly when updating records.

## Constraints

### Primary Keys

Every table has a single-column primary key on `id`:

```typescript
id: text('id').primaryKey(),
```

### Unique Constraints

Unique constraints are defined on columns that must have unique values:

```typescript
email: text('email').notNull().unique(),
```

### Foreign Keys

Foreign keys use cascade rules for referential integrity:

```typescript
userId: text('user_id')
  .notNull()
  .references(() => users.id, { onDelete: 'cascade' }),
```

Cascade behavior:

- `ON DELETE CASCADE`: Dependent records deleted when parent deleted
- `ON UPDATE NO ACTION`: Default PostgreSQL behavior

## Schema Structure

### Directory Layout

```
api/_db/
  client.ts       - postgres.js connection
  index.ts        - Drizzle instance with schema
  schema/
    index.ts      - Barrel export for all schemas
    users.ts      - Users table definition
    sessions.ts   - Sessions table definition
```

### Type Exports

Each schema file exports:

1. Table definition (e.g., `users`)
2. Select type (e.g., `User`)
3. Insert type (e.g., `NewUser`)

```typescript
export const users = pgTable('users', { ... });
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
```

## Tables Reference

### Users Table

Auth-ready users table for authentication:

| Column         | Type      | Constraints           | Description                   |
| -------------- | --------- | --------------------- | ----------------------------- |
| id             | TEXT      | PRIMARY KEY           | User identifier (UUID string) |
| email          | TEXT      | NOT NULL, UNIQUE      | User email address            |
| email_verified | BOOLEAN   | DEFAULT false         | Email verification status     |
| name           | TEXT      | NULLABLE              | User display name             |
| image          | TEXT      | NULLABLE              | Profile image URL             |
| created_at     | TIMESTAMP | NOT NULL, DEFAULT NOW | Record creation time          |
| updated_at     | TIMESTAMP | NOT NULL, DEFAULT NOW | Last update time              |

### Sessions Table

Auth-ready sessions table for session management:

| Column     | Type      | Constraints                        | Description                      |
| ---------- | --------- | ---------------------------------- | -------------------------------- |
| id         | TEXT      | PRIMARY KEY                        | Session identifier (UUID string) |
| user_id    | TEXT      | NOT NULL, FK -> users.id (CASCADE) | Owner user reference             |
| expires_at | TIMESTAMP | NOT NULL                           | Session expiration time          |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW              | Record creation time             |

## Migrations

### Location

Migrations are stored in the `drizzle/` directory:

```
drizzle/
  0000_lush_luke_cage.sql   - Initial schema migration
  meta/                     - Drizzle migration metadata
```

### Commands

```bash
# Generate migration from schema changes
npm run db:generate

# Apply pending migrations
npm run db:migrate

# Push schema directly (development only)
npm run db:push

# Launch Drizzle Studio UI
npm run db:studio
```

### Migration Workflow

1. Modify schema files in `api/_db/schema/`
2. Run `npm run db:generate` to create migration
3. Review generated SQL in `drizzle/` directory
4. Run `npm run db:migrate` to apply migration

## Best Practices

1. **Always use migrations**: Never modify the database directly in production
2. **Review generated SQL**: Verify migrations before applying
3. **Test migrations**: Run on a test database first
4. **Keep schemas minimal**: Only add columns when needed
5. **Use appropriate types**: Choose the correct data type for each column
6. **Document changes**: Update this file when adding new conventions

## Future Considerations

The schema is designed to be extended in future phases:

- **Phase 03**: Better Auth will add `accounts` and `verifications` tables
- **Future phases**: Application-specific tables (conversations, itineraries, etc.)

When adding new tables, follow the conventions established in this document.
